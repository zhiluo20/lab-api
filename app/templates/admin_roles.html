<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Admin | Roles</title>
    <style>
        body { font-family: sans-serif; margin: 2rem auto; max-width: 90rem; }
        header { display:flex; justify-content: space-between; align-items: center; }
        nav a { margin-left:0.5rem; text-decoration:none; padding:0.4rem 0.7rem; border-radius:0.3rem; background:#0b5; color:#fff; }
        .panel { margin-top:1.5rem; border:1px solid #ddd; padding:1rem; border-radius:0.4rem; background:#fafafa; }
        table { width:100%; border-collapse:collapse; margin-top:1rem; }
        th, td { border:1px solid #ccc; padding:0.5rem; text-align:left; vertical-align:top; }
        th { background:#f5f5f5; }
        label { display:block; margin-top:0.5rem; }
        input[type=text], textarea, select { width:100%; padding:0.4rem; margin-top:0.25rem; }
        button { padding:0.4rem 0.8rem; margin-top:0.4rem; }
        .tags span { display:inline-block; background:#eef; padding:0.2rem 0.5rem; margin:0 0.2rem 0.2rem 0; border-radius:0.3rem; }
        .flash { padding:0.6rem 0.9rem; border-radius:0.3rem; margin:0.7rem 0; }
        .flash.error { background:#fde2e2; color:#722; }
        .flash.success { background:#e1f4e1; color:#064; }
    </style>
</head>
<body>
    <header>
        <div>
            <h1>Role & Permission Management</h1>
            <p>Define reusable roles and granular permissions.</p>
        </div>
        <nav>
            <a href="{{ url_for('admin.admin_index', token=token) }}">Dashboard</a>
            <a href="{{ url_for('admin.list_users', token=token) }}">Users</a>
            <a href="{{ url_for('admin.list_documents', token=token) }}">Documents</a>
            <a href="{{ url_for('web.docs_list', token=token) }}">Return to docs</a>
        </nav>
    </header>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <section class="panel">
        <h2>Create role</h2>
        <form method="post" action="{{ url_for('admin.create_role') }}">
            <input type="hidden" name="token" value="{{ token }}" />
            <label>Name (unique slug)
                <input type="text" name="name" placeholder="editor" required />
            </label>
            <label>Description
                <textarea name="description" rows="2" placeholder="What can this role do?"></textarea>
            </label>
            <label><input type="checkbox" name="is_default" /> Assign to new users by default</label>
            <button type="submit">Create role</button>
        </form>
    </section>

    <section class="panel">
        <h2>Role catalog</h2>
        <table>
            <thead>
                <tr>
                    <th>Role</th>
                    <th>Permissions</th>
                    <th>Modify permissions</th>
                    <th>Danger zone</th>
                </tr>
            </thead>
            <tbody>
                {% for role in roles %}
                    <tr>
                        <td>
                            <strong>{{ role.name }}</strong><br/>
                            <small>{{ role.description or 'No description' }}</small><br/>
                            <small>Default: {{ 'Yes' if role.is_default else 'No' }}</small>
                        </td>
                        <td class="tags">
                            {% for perm in role.permissions %}
                                <span>{{ perm.resource }}:{{ perm.action }}</span>
                            {% endfor %}
                            {% if not role.permissions %}<span>â€”</span>{% endif %}
                        </td>
                        <td>
                            <form method="post" action="{{ url_for('admin.update_role_permissions', role_id=role.id) }}">
                                <input type="hidden" name="token" value="{{ token }}" />
                                <label>Resource
                                    <select name="resource">
                                        {% for resource in known_resources %}
                                            <option value="{{ resource }}">{{ resource }}</option>
                                        {% endfor %}
                                    </select>
                                </label>
                                <label>Action
                                    <select name="action">
                                        {% for action in known_actions %}
                                            <option value="{{ action }}">{{ action }}</option>
                                        {% endfor %}
                                    </select>
                                </label>
                                <label>Mode
                                    <select name="mode">
                                        <option value="add">Add</option>
                                        <option value="remove">Remove</option>
                                    </select>
                                </label>
                                <button type="submit">Apply</button>
                            </form>
                        </td>
                        <td>
                            <form method="post" action="{{ url_for('admin.delete_role', role_id=role.id) }}" onsubmit="return confirm('Delete this role?');">
                                <input type="hidden" name="token" value="{{ token }}" />
                                <button type="submit">Delete role</button>
                            </form>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>
</body>
</html>
